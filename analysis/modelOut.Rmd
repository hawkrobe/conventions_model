---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)
library(ggthemes)
```

Make plot from table in Clark paper

```{r}
data.frame(prediction = c(40.7, 19.1, 13.1, 11.0, 9.2, 8.2, 30.4, 18.1, 13.4, 8.2, 7.8, 6.7),
           t = seq(1,12),
           partner = factor(c(1,1,1,1,1,1,2,2,2,2,2,2))) %>%
  ggplot(aes(x = t, y = prediction, color = partner)) +
    geom_point() +
    geom_line() +
    theme_few() +
    xlab('trial #') +
    ylab("# words") +
    scale_x_continuous(breaks = c(1,3,5,7,9,11)) +
    geom_vline(aes(xintercept = 6.5)) +
    theme(aspect.ratio = 1)

ggsave('../../dissertation/dissertation/figures/modeling/clark92.pdf', height = 8, width = 8, units = 'cm', useDingbats = F)
```

## Simulating models & looking at post-test

```{r}
trajectories <- dir(path = "../simulations/cogsci2018/output/", pattern = "trajectory.*", full.names = T) %>%
  map(~ read_csv(.x) %>% select(gameNum, time, condition, correct,topSpeakerChoice) %>% mutate(filename=.x)) %>%
  reduce(rbind) %>%
  mutate(quarter = floor((time - 1) / 24)) %>%
  mutate(repNum = floor((time - 1) / 8)) %>%
  separate(filename, c('garbage1', 'garbage2', 'discount', 'coord'), sep="_") %>%
  mutate(discount = gsub("discount", "", discount),
         coord = ifelse(coord == 'same', 'same', 'diff')) %>%
  select(-starts_with("garbage")) %>%
  mutate(condition = case_when(condition == 'subOnly' ~ 'fine', 
                               condition == 'mixedLower' ~ 'mixed', 
                               TRUE ~ 'coarse')) 

  
trajectories %>% 
#  filter(coord == 'diff') %>%
  group_by(condition, discount, time) %>%
  tidyboot::tidyboot_mean(correct, nboot=100) %>%
  ggplot(aes(x = time, y = empirical_stat, color = condition)) +
    geom_point(alpha=0.5) +
    ylim(0, 1) +
    geom_smooth() +
    facet_wrap(~ paste0('discount:', discount)) +
    labs(y = 'proportion correct', x = 'trial number') +
    theme_few() 

```


```{r}
trajectories %>%
  filter(coord == 'diff') %>%
  group_by(gameNum, condition, discount, repNum) %>%
  mutate(numUniqueWordsUsed = length(unique(topSpeakerChoice))) %>%
  group_by(condition, repNum, discount) %>%
  tidyboot::tidyboot_mean(numUniqueWordsUsed, nboot= 100) %>%
  ggplot(aes(x = repNum, y = empirical_stat, color = condition)) +
    geom_line() +
    facet_wrap(~ discount) +
    ylim(3.5, 8.5) +
    geom_hline(yintercept = c(4, 8)) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width=0) +
    theme_few() +
    labs(y = "number unique words used")
```

```{r}
trajectories %>% 
  filter(discount == 0.8) %>%
  group_by(condition, coord, time) %>%
  tidyboot::tidyboot_mean(correct, nboot=100) %>%
  ggplot(aes(x = time, y = empirical_stat, color = condition)) +
    geom_point(alpha=0.5) +
    ylim(0, 1) +
    geom_smooth() +
    facet_wrap(~ coord) +
    labs(y = 'proportion correct', x = 'trial number') +
    theme_few() 

```

```{r}
trajectories %>%
  filter(discount == 0.8) %>%
  group_by(gameNum, condition, coord, repNum) %>%
  mutate(numUniqueWordsUsed = length(unique(topSpeakerChoice))) %>%
  group_by(condition, repNum, coord) %>%
  tidyboot::tidyboot_mean(numUniqueWordsUsed, nboot= 100) %>%
  ggplot(aes(x = repNum, y = empirical_stat, color = condition)) +
    geom_line() +
    facet_wrap(~ coord) +
    ylim(3.5, 8.5) +
    geom_hline(yintercept = c(4, 8)) +
    geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width=0) +
    theme_few() +
    labs(y = "number unique words used")

```




```{r}
softmax <- function(outVec){
  s.vec <- exp(outVec)/sum(exp(outVec))
  return(s.vec)
}

postTest <- read_csv('../simulations/cogsci2018/testing_game101.csv') %>%
  left_join(trajectories %>% group_by(gameNum) %>% filter(row_number() == 1))

postTest %>%
  filter(trialNum == 96) %>%
  mutate(aboveThreshold = val > -1) %>%
  group_by(gameNum, condition, agentID, word, aboveThreshold) %>%
  tally() %>%
  filter(aboveThreshold) %>%
  group_by(condition, n) %>%
  tally()
  
postTest %>%
  filter(trialNum == 96) %>%
  group_by(word) %>%
  mutate(val = softmax(val)) %>%
  ggplot(aes(x = word, y = object, fill = val)) +
    geom_tile() +
    facet_wrap(condition ~ gameNum)

ggsave("big_tile.pdf", width = 10, height = 10, units = 'in')
```

## Fitting human data

```{r}
modelInput <- dir(path = "../simulations/cogsci2018/input/",
    pattern = "game*",
    full.names = T) %>%
  map(read_csv) %>%
  reduce(rbind) %>%
  rename(time = trialNum, gameNum = id)

modelOutput <- dir(path = "../simulations/cogsci2018/output/",
    pattern = "*.csv",
    full.names = T) %>%
  map(read_csv) %>%
  reduce(rbind) %>%
  left_join(modelInput, by = c('gameNum', 'time', 'speakerID', 'listenerID')) %>%
  mutate(sameUtteranceAsParticipant = topSpeakerChoice==trueUtterance,
         sameSelectionAsParticipant = topListenerChoice == trueResponse)
```

Model accuracy appears to track participant accuracy at each point in time... 

```{r}
modelOutput %>%
  gather(src,value,modelCorrect, participantCorrect) %>%
  group_by(time, condition, src) %>%
  summarize(m = mean(value)) %>%
  ggplot(aes(x = time, y = m, color = src)) +
    geom_point() +
    geom_smooth() +
    facet_grid(condition ~ .) +
    theme_few()
```

Predicting utterance is harder than predicting selection. And we make better predictions over time (maybe not surprising, since human behavior stabilizes later on)

```{r}
modelOutput %>%
  gather(src,value,sameUtteranceAsParticipant,sameSelectionAsParticipant) %>%
  group_by(time, condition, src) %>%
  summarize(m = mean(value)) %>%
  ggplot(aes(x = time, y = m, color = src)) +
    geom_point(alpha = 0.25) +
    geom_smooth() +
    facet_grid(condition ~ .) +
    theme_few()
```

```{r}
modelOutput %>%
  gather(src,value,speakerPredictionLikelihood,listenerPredictionLikelihood) %>%
  group_by(time, condition, src) %>%
  summarize(m = mean(value)) %>%
  ggplot(aes(x = time, y = m)) +
    geom_point(alpha = 0.25) +
    geom_smooth() +
    facet_grid(src ~ condition, scale = 'free_y') +
    theme_few()
```